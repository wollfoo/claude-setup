
## ü§ñ SUB-AGENT AUTO-DETECTION RULES (QUY T·∫ÆC T·ª∞ ƒê·ªòNG PH√ÅT HI·ªÜN SUB-AGENT)

> SSOT note: This file provides a high-level overview of sub‚Äëagent selection rules. The detailed routing logic (algorithms, thresholds, decision tables, triggers) is defined in `ORCHESTRATOR.md`. Do not duplicate execution details here. In case of conflict, follow `RULE-PRECEDENCE.md`.

### **MANDATORY SUB-AGENT DETECTION**
- **AUTO-TRIGGER**: Khi nh·∫≠n task m·ªõi, B·∫ÆT BU·ªòC ph√¢n t√≠ch v√† l·ª±a ch·ªçn Sub-Agent ph√π h·ª£p
- **CONFIDENCE THRESHOLD**: Ch·ªâ th·ª±c thi khi confidence ‚â• 80%
- **FALLBACK**: N·∫øu kh√¥ng t√¨m th·∫•y Sub-Agent chuy√™n bi·ªát, s·ª≠ d·ª•ng universal agent

### **Detection Algorithm (Thu·∫≠t to√°n ph√°t hi·ªán)**
1. **Parse user request** for keywords and patterns
2. **Match against domain/operation matrices** (frontend, backend, infrastructure, etc.)
3. **Score complexity** based on scope and steps (simple: <5min, moderate: 5-30min, complex: >30min)
4. **Evaluate wave opportunity** scoring (complexity ‚â•0.7 + files >20 + operation_types >2)
5. **Estimate resource requirements** (tokens, time, tools)
6. **Generate routing recommendation** (traditional vs wave mode)
7. **Apply auto-detection triggers** for Sub-Agent activation

### **Auto-Activation Triggers (K√≠ch ho·∫°t t·ª± ƒë·ªông)**
- **Directory count >7**: `--delegate --parallel-dirs` (95% confidence)
- **File count >50 AND complexity >0.6**: `--delegate --sub-agents [calculated]` (90% confidence)
- **Multi-domain operations >3**: `--delegate --parallel-focus` (85% confidence)
- **Complex analysis >0.8**: `--delegate --focus-agents` (90% confidence)
- **Token requirements >20K**: `--delegate --aggregate-results` (80% confidence)

### **Sub-Agent Specialization Matrix (Ma tr·∫≠n chuy√™n bi·ªát)**
- **Quality**: qa persona, complexity/maintainability focus, Read/Grep/Sequential tools
- **Performance**: performance persona, bottlenecks/optimization focus, Read/Sequential/Playwright tools
- **Architecture**: architect persona, patterns/structure focus, Read/Sequential/Context7 tools
- **API**: backend persona, endpoints/contracts focus, Grep/Context7/Sequential tools
- **Frontend**: frontend persona, UI/UX focus, Magic/Context7/Playwright tools
- **Backend**: backend persona, server-side focus, Context7/Sequential tools

### **Wave-Specific Specialization (Chuy√™n bi·ªát theo Wave)**
- **Review**: analyzer persona, current_state/quality_assessment focus, Read/Grep/Sequential tools
- **Planning**: architect persona, strategy/design focus, Sequential/Context7/Write tools
- **Implementation**: intelligent persona, code_modification/feature_creation focus, Edit/MultiEdit/Task tools
- **Validation**: qa persona, testing/validation focus, Sequential/Playwright/Context7 tools
- **Optimization**: performance persona, performance_tuning/resource_optimization focus, Read/Sequential/Grep tools

### **MCP Server Auto-Activation (K√≠ch ho·∫°t t·ª± ƒë·ªông MCP Server)**
- **Context7**: External library imports, framework questions, documentation requests
- **Sequential**: Complex debugging, system design, any --think flags
- **Magic**: UI component requests, design system queries, frontend persona
- **Playwright**: Testing workflows, performance monitoring, QA persona

### **Persona Auto-Activation (K√≠ch ho·∫°t t·ª± ƒë·ªông Persona)**
- **Performance Issues** ‚Üí `--persona-performance` + `--focus performance` (85% confidence)
- **UI/UX Tasks** ‚Üí `--persona-frontend` + `--magic` (80% confidence)
- **Complex Debugging** ‚Üí `--persona-analyzer` + `--think` + `--seq` (75% confidence)
- **Documentation Tasks** ‚Üí `--persona-scribe=en` (70% confidence)

### **Quality Gates for Sub-Agent Selection (C·ªïng ki·ªÉm tra ch·∫•t l∆∞·ª£ng)**
- **Resource Validation**: Check token budget, processing requirements, file system permissions
- **Compatibility Verification**: Ensure flag combinations don't conflict
- **Risk Assessment**: Evaluate failure probability and cascading failure potential
- **Outcome Prediction**: Validate Sub-Agent selection against expected results

### Task Management Rules
- TodoRead() ‚Üí TodoWrite(3+ tasks) ‚Üí Execute ‚Üí Track progress
- Follow mode-based tool policy per `GLOBAL-DIRECTIVES.md` and `PROFILE-MODES.md` (sequential-only in standard/research)
- Parallel/batched tool calls only in full-de-restriction mode with an Action Ledger (Goal/Plan/Tool Calls/Results/Evidence)
- Always validate before execution, verify after completion
- Run lint/typecheck before marking tasks complete
- Use /spawn and /task for complex multi-session workflows
- Maintain ‚â•90% context retention across operations

### Framework Compliance
- Check package.json/requirements.txt before using libraries
- Follow existing project patterns and conventions
- Use project's existing import styles and organization
{{ ... }}
- Validate related functionality remains working
- Use Task tool for comprehensive searches when scope uncertain

## Quick Reference

### Do
Read before Write/Edit/Update
Follow mode-based tool policy (sequential in standard/research; parallel only in full-de-restriction with Action Ledger)
Validate before execution
Check framework compatibility
Auto-activate personas
Preserve context across operations
Use quality gates (see ORCHESTRATOR.md)
Complete discovery before codebase changes
Verify completion with evidence
Reference `RULE-PRECEDENCE.md` to resolve conflicts systematically
**MANDATORY**: Auto-detect and select Sub-Agents for all tasks
**CONFIDENCE**: Only execute when Sub-Agent confidence ‚â• 80%
**SPECIALIZATION**: Use domain-specific Sub-Agents over universal ones

### Don't
Skip Read operations
Auto-commit without permission
Ignore framework patterns
Skip validation steps
Mix user-facing content in config
Make reactive codebase changes
Mark complete without verification
**NEVER**: Skip Sub-Agent detection for complex tasks
**NEVER**: Use universal agents when specialists are available
**NEVER**: Execute without confidence threshold validation
Assume parallel tool calls outside full‚Äëde‚Äërestriction mode

### Auto-Triggers
- Wave mode: complexity ‚â•0.7 + multiple domains
- Personas: domain keywords + complexity assessment  
- MCP servers: task type + performance requirements
- **Sub-Agent delegation**: >7 directories OR >50 files OR complexity >0.8
- **Wave auto-activation**: complexity ‚â•0.7 AND files >20 AND operation_types >2
- **Loop auto-activation**: polish, refine, enhance, improve keywords detected