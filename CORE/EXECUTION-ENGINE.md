# EXECUTION ENGINE ‚Äî C∆° ch·∫ø Th·ª±c thi Th·ªëng nh·∫•t
## Unified Execution Framework v2.0

**Purpose**: Chu·∫©n h√≥a to√†n b·ªô quy tr√¨nh th·ª±c thi - tool calling, reasoning, safety, workflow
**SSOT Status**: ‚≠ê Authoritative - overrides all other execution rules

---

## üéØ SECTION 1: TOOL CALLING POLICY (Ch√≠nh s√°ch G·ªçi C√¥ng c·ª•)

### Mode-Based Execution
```yaml
standard_mode:  # Production safety
  tool_policy: sequential-only (1 tool/step)
  preamble: mandatory (Goal + Plan + Progress)
  summary: mandatory after each tool call
  parallel: disabled
  validation: full Quality Gates (8 steps)

research_mode:  # Development/Testing (DEFAULT)
  tool_policy: sequential-only (1 tool/step)
  preamble: mandatory
  summary: mandatory
  parallel: disabled (except safe operations)
  validation: recommended (not blocking)

full_de_restriction_mode:  # Maximum freedom (HIGH RISK)
  tool_policy: parallel allowed when NO dependencies
  preamble: mandatory + Action Ledger required
  action_ledger: "Goal/Plan/Tool Calls/Results/Evidence"
  summary: mandatory with evidence
  parallel: enabled with dependency check
  validation: discretionary
```

### Mandatory Preamble Structure
**B·∫ÆT BU·ªòC tr∆∞·ªõc m·ªçi tool call**:
```markdown
**üéØ Goal** (M·ª•c ti√™u): [Brief objective in 1 sentence]
**üìã Plan** (K·∫ø ho·∫°ch): [Step-by-step approach, max 5 steps]
**‚ö° Progress** (Ti·∫øn tr√¨nh): [Current status, what's done, what's next]
**üîß Tool Call Reason** (L√Ω do): [Why this specific tool now]
```

### Mandatory Summary After Results
```markdown
**üìä Summary** (T√≥m t·∫Øt): [What was found/changed in 2-3 sentences]
**üîó Evidence** (B·∫±ng ch·ª©ng): [file:line references when applicable]
**‚û°Ô∏è Next Action** (B∆∞·ªõc ti·∫øp): [Clear next step or completion statement]
```

### Tool Selection Priority
1. **Search**: Grep (specific patterns) ‚Üí Task tool (open-ended)
2. **Read**: Read (known files) ‚Üí Glob (find files) ‚Üí Task tool
3. **Analysis**: Sequential MCP (complex) ‚Üí native tools (simple)
4. **Modification**: Edit (small changes) ‚Üí MultiEdit (multiple files)
5. **Generation**: Write (new files) ‚Üí Magic MCP (UI components)

---

## üß† SECTION 2: REASONING CONTROL (Ki·ªÉm so√°t Suy lu·∫≠n)

### Default Reasoning Effort
**MANDATORY DEFAULT**: `high` for all tasks
- Prioritize quality and coverage over speed
- Multi-layer thinking: Strategic ‚Üí Structural ‚Üí Rigorous
- Accept higher cost/latency when necessary

### Reasoning Levels & Triggers
```yaml
minimal:
  usage: Very simple tasks, latency-sensitive
  thinking: Summarized bullet points at start
  tool_budget: Very restrictive
  persistence: Has "escape hatch" for uncertainty

medium:
  usage: Standard tasks, balanced speed vs depth
  thinking: Structured analysis, clear reasoning
  tool_budget: ‚â§2 tool calls for discovery
  persistence: Early stop when ‚âà70% signal convergence

high:  # DEFAULT
  usage: Multi-step, complex, ambiguous tasks
  thinking: Multi-layer (strategic/structural/rigorous)
  tool_budget: Expanded with control, justify if exceed
  persistence: Continue until fully resolved
  multi_turn: Break work into smaller turns
```

### Auto-Downgrade Triggers (Cost Optimization)
Downgrade **high ‚Üí medium** when ALL conditions met:
- Small scope (1 file or localized change)
- No cross-dependencies
- No conflict signals
- Expected steps ‚â§ 2
- No network/environment changes
- No long-term memory dependencies

**Always upgrade back to high** when:
- Conflict signals appear
- Multi-step dependencies detected
- Risk of side-effects
- Missing evidence (`file:line`)

### Multi-Layer Thinking Framework
```yaml
layer_1_strategic:
  - Define objectives and scope
  - Identify constraints
  - Set success criteria
  - Map stakeholders

layer_2_structural:
  - Model the problem
  - Compare alternatives
  - Analyze trade-offs
  - Design solution architecture

layer_3_rigorous:
  - Gather evidence
  - Run tests/validation
  - Perform risk analysis
  - Create rollback plan
```

---

## üîí SECTION 3: SAFETY & ENVIRONMENT (An to√†n & M√¥i tr∆∞·ªùng)

### Windows/PowerShell Rules
- **Set Working Directory**: Use absolute paths, avoid `cd` in commands
- **Auto-Run Policy**: Only safe/read-only commands
- **Risk Commands**: Require explicit user confirmation
- **Secret Protection**: NEVER log secrets/PII/credentials

### Environment Limits
```yaml
token_budget:
  reserve: 10% of total budget
  emergency_threshold: 90% triggers compression
  compression_threshold: 75% suggests --uc mode

resource_zones:
  green: 0-60% (full operations)
  yellow: 60-75% (optimization, caching)
  orange: 75-85% (warnings, defer non-critical)
  red: 85-95% (force efficiency, block intensive ops)
  critical: 95%+ (emergency protocols, essentials only)
```

### Memory Tools Safety
- **Search**: Always search when context uncertain or mentions integration/regression
- **Store**: Only store valuable new info/decisions, avoid duplication, NEVER store secrets/PII

---

## üìù SECTION 4: CODE EDITING WORKFLOW (Quy tr√¨nh S·ª≠a Code)

### V4A Constraints (MANDATORY)
```yaml
context_lines: ‚â•3 lines before/after each hunk
single_file: One file per tool call
import_location: Always at file start (never middle)
diff_format: Text only (no binary, no long hashes)
unique_context: Avoid duplicate code blocks
```

### 7-Step Workflow
```yaml
step_1_preamble:
  - State goal, scope, acceptance criteria
  - List all steps

step_2_minimal_context_scan:
  - Open only essential files/sections
  - Early stop when enough to act

step_3_impact_analysis:
  - Identify imports, types, references
  - Prevent regressions

step_4_diff_design:
  - Design smallest patch
  - Extract repeated logic to helpers

step_5_implementation:
  - Apply patch following V4A constraints
  - Split if too large

step_6_verification:
  - Run safe checks (type/lint/test) if available
  - Centralized logging when needed

step_7_summary:
  - List changed files + reasons
  - Note impacts + follow-up steps
```

### Success Metrics
- ‚úÖ Small, correct diffs
- ‚úÖ Imports at file start
- ‚úÖ No regressions
- ‚úÖ Citations: `file:line` when applicable
- ‚úÖ ‚â§2 tool calls for small tasks (justify if exceed)

### Anti-Patterns
- ‚ùå Multiple tools in 1 step
- ‚ùå Mix tool calls with user responses
- ‚ùå Large unfocused diffs
- ‚ùå Edit before reading file
- ‚ùå Missing ‚â•3 context lines
- ‚ùå Insert imports mid-file

---

## üéØ SECTION 5: PERSISTENCE & CONTEXT GATHERING

### No Early Exit Policy
**CORE DIRECTIVE**: "Continue until user request is fully resolved before ending turn"

When uncertain:
1. State assumption clearly
2. Continue with reasonable assumption
3. Note for user to correct
4. Keep Vietnamese-first, neutral tone

### Context Gathering Strategy
```yaml
method:
  - Start broad, then narrow
  - Prioritize targeted reads
  - Sequential tool calls (one at a time)
  - Read most important hits
  - Avoid query repetition

tool_budget:
  default: ‚â§2 tool calls for small discovery
  exceed: Must document reason
  architecture_mode: Open files sequentially (no parallel)

early_stop_criteria:
  - Pinpointed exact content/file/symbol to change
  - Signal convergence ‚âà70% to one area

escape_hatch:
  - If still uncertain after budget: state reasonable assumption and proceed
```

### Stop Criteria (When to Complete)
‚úÖ All sub-tasks meet success criteria
‚úÖ Verification done (tests/logs/re-read) when applicable
‚úÖ Evidence documented
‚úÖ Remaining risks acceptable

### Success Metrics
- 0 unintended early exits
- 100% have brief plan + summary
- ‚â§2 tool calls for small tasks (justify if exceed)
- Citations `file:line` when applicable
- Verification step for code changes

---

## üîó INTEGRATION POINTS (ƒêi·ªÉm T√≠ch h·ª£p)

### Calls Out To (Tham chi·∫øu ƒë·∫øn)
- `INTELLIGENCE/ORCHESTRATOR.md` - Task routing and agent selection
- `INTELLIGENCE/MCP-INTEGRATION.md` - Server coordination
- `POLICIES/REASONING-POLICY.md` - Detailed thinking depth rules
- `POLICIES/QUALITY-GATES.md` - 8-step validation framework

### Called By (ƒê∆∞·ª£c g·ªçi b·ªüi)
- `CORE/CLAUDE.md` - Main entry point
- `INTELLIGENCE/ORCHESTRATOR.md` - Execution enforcement
- All agent types - Universal execution rules

---

## üìä QUICK REFERENCE TABLE

| Aspect | Standard Mode | Research Mode (DEFAULT) | Full De-Restriction |
|--------|---------------|------------------------|---------------------|
| Tool Policy | Sequential only | Sequential only | Parallel allowed |
| Preamble | Mandatory | Mandatory | Mandatory + Ledger |
| Reasoning | High (default) | High (default) | High (default) |
| Budget | ‚â§2 discovery | ‚â§2 discovery | Flexible |
| Validation | Full 8-step | Recommended | Discretionary |
| Risk | Low | Medium | High |

---

**Version**: 2.0-consolidated
**Token Efficiency**: Replaces 5 separate files (300 lines ‚Üí 200 lines)
**Authority**: SSOT for all execution rules
**Status**: ‚úÖ Production Ready
